# Copyright 2025 Cisco Systems, Inc. and its affiliates
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)

---

- name: Verify required variables for selected role
  ansible.builtin.include_tasks: variables_assertion.yml

- name: "Set multitenant mode for vManage {{ (vmanage_instances | first).hostname }}"
  cisco.catalystwan.cluster_management:
    wait_until_configured_seconds: 300
    tenancy:
      mode: multi
      domain: "{{ multitenant_domain }}"
    manager_authentication:
      url: "{{ (vmanage_instances | first).mgmt_public_ip }}"
      username: "{{ (vmanage_instances | first).admin_username }}"
      password: "{{ (vmanage_instances | first).admin_password }}"
  register: updated_tenancy_mode

- name: Wait for Manager to restart
  ansible.builtin.pause:
    seconds: 60
  when: updated_tenancy_mode.changed  # noqa: no-handler

- name: Wait for Manager to be ready
  ansible.builtin.include_role:
    name: cisco.catalystwan.api_ready
  when: updated_tenancy_mode.changed  # noqa: no-handler
