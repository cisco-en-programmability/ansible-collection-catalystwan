# Copyright 2024 Cisco Systems, Inc. and its affiliates
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)

---

- name: Verify required variables for selected role
  ansible.builtin.include_tasks: variables_assertion.yml

- name: Inform user that in case of PnP portal sync, devices have to be defined in PnP
  ansible.builtin.pause:
    prompt: |-

      Please verify that your PnP Portal Devices list is not empty.

      Press any key to continue, press `Ctrl + C` and `Shift + A` to abort
  register: user_response

- name: Sync edges in single tenant environment
  ansible.builtin.include_tasks: sync_pnp_edges.yml
  when: not tenants

- name: Sync edges in multitenant tenant environment
  ansible.builtin.include_tasks:
    file: sync_pnp_edges.yml
    apply:
      vars:
        provider_mode: true
        tenant_subdomain: "{{ tenant_item.subdomain }}"
        tenant_org: "{{ tenant_item.org_name }}"
        wan_edge_list_path: "{{ tenant_item.wan_edge_list_path or omit }}"
  loop: "{{ tenants }}"
  loop_control:
    loop_var: tenant_item
    label: "{{ tenant_item.name }}"
    index_var: "tenant_id"

- name: "Generate file to store edge deployment configuration, path: {{ deployment_edges_config }}"
  ansible.builtin.blockinfile:
    create: true
    state: present
    mode: "0644"
    insertafter: EOF
    dest: "{{ deployment_edges_config }}"
    content: "{{ generated_data_edge_instances | to_nice_yaml(indent=2) }}"
