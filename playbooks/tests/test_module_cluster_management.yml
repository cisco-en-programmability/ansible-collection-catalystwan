# Copyright 2024 Cisco Systems, Inc. and its affiliates
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)

---
- name: Testing playbook to verify cisco.catalystwan.cluster
  hosts: localhost
  gather_facts: false
  vars_files:
    - configuration_file_dev_vars.yml
  tasks:
    - name: "Edit cluster IP address for Manager {{ (manager_instances | first).hostname }}"
      cisco.catalystwan.cluster_management:
        wait_until_configured_seconds: 300
        manager_id: "0"
        system_ip: "{{ (manager_instances | first).system_ip }}"
        cluster_ip: "{{ (manager_instances | first).cluster_private_ip }}"
        username: "{{ (manager_instances | first).admin_username }}"
        password: "{{ (manager_instances | first).admin_password }}"
        persona: "{{ (manager_instances | first).persona }}"
        services:
          sd-avc:
            server: false
        manager_authentication:
          url: "{{ (manager_instances | first).mgmt_public_ip }}"
          username: "{{ (manager_instances | first).admin_username }}"
          password: "{{ (manager_instances | first).admin_password }}"

    - name: Add remaining instances to cluster
      cisco.catalystwan.cluster_management:
        wait_until_configured_seconds: 1800
        system_ip: "{{ manager.system_ip }}"
        cluster_ip: "{{ manager.cluster_private_ip }}"
        username: "{{ manager.admin_username }}"
        password: "{{ manager.admin_password }}"
        gen_csr: false
        persona: "{{ manager.persona }}"
        services:
          sd-avc:
            server: false
        manager_authentication:
          url: "{{ (manager_instances | first).mgmt_public_ip }}"
          username: "{{ (manager_instances | first).admin_username }}"
          password: "{{ (manager_instances | first).admin_password }}"
      loop: "{{ manager_instances[1:] }}"
      loop_control:
        loop_var: manager
      when: manager.cluster_private_ip is defined
      retries: 180
      delay: 10
